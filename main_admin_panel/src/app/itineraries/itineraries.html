<!-- Itinerary Management Page -->
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="h3 mb-0">ðŸ“‹ Itinerary Management</h2>
          <p class="text-muted mb-0">Create day-by-day schedules for your tours</p>
        </div>
        <button class="btn btn-primary" (click)="addNewItinerary()">
          <i class="fas fa-plus me-2"></i>Create Itinerary
        </button>
      </div>

      <!-- Search and Filters -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-5">
              <input 
                type="text" 
                class="form-control" 
                placeholder="ðŸ” Search itineraries..." 
                [(ngModel)]="searchTerm"
                (input)="onSearchChange()">
            </div>
            <div class="col-md-3">
              <select class="form-select" [(ngModel)]="statusFilter" (change)="onFilterChange()">
                <option value="all">All Status</option>
                <option value="active">Active</option>
                <option value="draft">Draft</option>
                <option value="archived">Archived</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-outline-success w-100" (click)="refreshItineraries()" [disabled]="isLoading" title="Refresh">
                <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i> Refresh
              </button>
            </div>
            <div class="col-md-2">
              <button class="btn btn-outline-secondary w-100" (click)="exportItineraries()" title="Export">
                <i class="fas fa-download"></i> Export
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Error Message -->
      @if (errorMessage) {
        <div class="alert alert-danger alert-dismissible fade show">
          <i class="fas fa-exclamation-triangle me-2"></i>
          {{ errorMessage }}
          <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
        </div>
      }
      
      <!-- Loading State -->
      @if (isLoading) {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Loading itineraries...</p>
        </div>
      }

      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-md-2">
          <div class="card bg-primary text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title mb-1">Total</h6>
                  <h3 class="mb-0">{{ stats.total }}</h3>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-map-marked-alt fa-2x opacity-75"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-success text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title mb-1">Active</h6>
                  <h3 class="mb-0">{{ stats.active }}</h3>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-check-circle fa-2x opacity-75"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-warning text-dark">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title mb-1">Draft</h6>
                  <h3 class="mb-0">{{ stats.draft }}</h3>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-file-alt fa-2x opacity-75"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-secondary text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title mb-1">Archived</h6>
                  <h3 class="mb-0">{{ stats.archived }}</h3>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-archive fa-2x opacity-75"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-info text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title mb-1">With Schedule</h6>
                  <h3 class="mb-0">{{ stats.withSchedule }} <small class="fs-6">/ {{ stats.total }}</small></h3>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-calendar-check fa-2x opacity-75"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Itineraries List -->
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">Itineraries ({{ filteredItineraries.length }})</h5>
        </div>
        <div class="card-body p-0">
          @if (filteredItineraries.length === 0 && !isLoading) {
            <div class="text-center py-5">
              <i class="fas fa-map-marked-alt fa-4x text-muted mb-3"></i>
              <h4 class="text-muted">No Itineraries Found</h4>
              <p class="text-muted">Create your first itinerary to get started!</p>
              <button class="btn btn-primary mt-3" (click)="addNewItinerary()">
                <i class="fas fa-plus me-2"></i>Create Itinerary
              </button>
            </div>
          } @else {
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width: 5%">#</th>
                    <th style="width: 30%">Tour Name</th>
                    <th style="width: 10%">Duration</th>
                    <th style="width: 10%">Schedule</th>
                    <th style="width: 10%">Bookings</th>
                    <th style="width: 10%">Status</th>
                    <th style="width: 15%">Created By</th>
                    <th style="width: 10%">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  @for (itinerary of filteredItineraries; track itinerary.id) {
                    <tr>
                      <td>{{ itinerary.id }}</td>
                      <td>
                        <strong>{{ itinerary.tour_name }}</strong>
                      </td>
                      <td>
                        <i class="fas fa-calendar-day me-1"></i>
                        {{ itinerary.total_days }} days
                      </td>
                      <td>
                        @if ((itinerary.schedule_count || 0) > 0) {
                          <span class="badge bg-success">
                            <i class="fas fa-check me-1"></i>
                            {{ itinerary.schedule_count }} days
                          </span>
                        } @else {
                          <span class="badge bg-warning text-dark">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            No schedule
                          </span>
                        }
                      </td>
                      <td>
                        <span class="badge bg-info">
                          {{ itinerary.booking_count || 0 }}
                        </span>
                      </td>
                      <td>
                        <span class="badge" [ngClass]="getBadgeClass(itinerary.status)">
                          {{ itinerary.status | titlecase }}
                        </span>
                      </td>
                      <td>
                        <small class="text-muted">
                          {{ itinerary.creator_name || 'Admin' }}
                        </small>
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <button class="btn btn-outline-primary" (click)="editItinerary(itinerary.id)" title="Edit">
                            <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-outline-danger" (click)="deleteItinerary(itinerary.id)" title="Delete">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Itinerary Modal -->
@if (showModal) {
  <div class="modal fade show d-block" tabindex="-1" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="z-index: 10000; position: relative; margin: 1.75rem auto;">
      <div class="modal-content" style="z-index: 10001; position: fixed; right: 15%; top: 10%; width: 60%; height: 80%;">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="fas fa-map-marked-alt me-2"></i>
            {{ isEditMode ? 'Edit Itinerary' : 'Create New Itinerary' }}
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeModal()"></button>
        </div>
        <div class="modal-body flex">
          <!-- Basic Information -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Select Tour <span class="text-danger">*</span></label>
                  <select class="form-select" [(ngModel)]="formData.tour_id" (change)="onTourSelected()" [disabled]="isEditMode">
                    <option [ngValue]="0">-- Select a Tour --</option>
                    @if (tours && tours.length > 0) {
                      @for (tour of tours; track tour.id) {
                        <option [ngValue]="tour.id">
                          {{ tour.title }} ({{ tour.destination }}, {{ tour.duration_days }} days)
                        </option>
                      }
                    }
                  </select>
                  <small class="text-muted">Choose a tour to create itinerary for</small>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tour Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" [(ngModel)]="formData.tour_name" placeholder="Enter tour name">
                  <small class="text-muted">Auto-filled from selected tour</small>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Total Days <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" [(ngModel)]="formData.total_days" min="1" max="365">
                  <small class="text-muted">Total duration of the tour</small>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Status</label>
                  <select class="form-select" [(ngModel)]="formData.status">
                    <option value="draft">Draft</option>
                    <option value="active">Active</option>
                    <option value="archived">Archived</option>
                  </select>
                  <small class="text-muted">Itinerary status</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Day-by-Day Schedule -->
          <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Day-by-Day Schedule</h6>
              <button class="btn btn-sm btn-success" (click)="addDay()">
                <i class="fas fa-plus me-1"></i>Add Day
              </button>
            </div>
            <div class="card-body">
              @if (formData.schedule.length === 0) {
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>
                  No schedule added yet. Click "Add Day" to create day-by-day itinerary.
                </div>
              } @else {
                <!-- Schedule Days List -->
                <div class="row">
                  <!-- Days List (Left Side) -->
                  <div class="col-md-4">
                    <div class="list-group">
                      @for (day of formData.schedule; track day.day_number) {
                        <div class="list-group-item" [class.active]="editingDay?.day_number === day.day_number">
                          <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1" (click)="editDay(day)" style="cursor: pointer;">
                              <h6 class="mb-1">Day {{ day.day_number }}</h6>
                              <small>{{ day.title || 'Untitled' }}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger ms-2" (click)="deleteDay(day.day_number)" title="Delete Day">
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>
                        </div>
                      }
                    </div>
                  </div>

                  <!-- Day Editor (Right Side) -->
                  <div class="col-md-8">
                    @if (editingDay) {
                      <div class="card">
                        <div class="card-header bg-primary text-white">
                          <h6 class="mb-0">Editing: Day {{ editingDay.day_number }}</h6>
                        </div>
                        <div class="card-body">
                          <div class="mb-3">
                            <label class="form-label">Day Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" [(ngModel)]="editingDay.title" placeholder="e.g., Arrival in Delhi">
                          </div>
                          
                          <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" [(ngModel)]="editingDay.description" rows="3" 
                              placeholder="Detailed description of the day's activities"></textarea>
                          </div>
                          
                          <div class="row mb-3">
                            <div class="col-md-6">
                              <label class="form-label">Time Schedule</label>
                              <input type="text" class="form-control" [(ngModel)]="editingDay.time_schedule" 
                                placeholder="e.g., 9:00 AM - 6:00 PM">
                            </div>
                            <div class="col-md-6">
                              <label class="form-label">Location</label>
                              <input type="text" class="form-control" [(ngModel)]="editingDay.location" 
                                placeholder="e.g., Delhi, India">
                            </div>
                          </div>
                          
                          <div class="mb-3">
                            <label class="form-label">Activities</label>
                            <div class="input-group mb-2">
                              <input type="text" class="form-control" [(ngModel)]="newActivity" 
                                placeholder="Add activity (e.g., Visit Red Fort)"
                                (keyup.enter)="addActivity()">
                              <button class="btn btn-outline-success" (click)="addActivity()">
                                <i class="fas fa-plus"></i> Add
                              </button>
                            </div>
                            
                            @if (editingDay.activities && editingDay.activities.length > 0) {
                              <ul class="list-group">
                                @for (activity of editingDay.activities; track $index) {
                                  <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-check-circle text-success me-2"></i>{{ activity }}</span>
                                    <button class="btn btn-sm btn-outline-danger" (click)="removeActivity($index)">
                                      <i class="fas fa-times"></i>
                                    </button>
                                  </li>
                                }
                              </ul>
                            } @else {
                              <p class="text-muted"><small>No activities added yet</small></p>
                            }
                          </div>
                          
                          <div class="d-flex gap-2">
                            <button class="btn btn-primary" (click)="saveDayEdits()">
                              <i class="fas fa-save me-1"></i>Save Day
                            </button>
                            <button class="btn btn-secondary" (click)="cancelDayEdits()">
                              <i class="fas fa-times me-1"></i>Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    } @else {
                      <div class="alert alert-info">
                        <i class="fas fa-arrow-left me-2"></i>
                        Select a day from the list to edit
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">
            <i class="fas fa-times me-1"></i>Cancel
          </button>
          <button type="button" class="btn btn-primary" (click)="saveItinerary()">
            <i class="fas fa-save me-1"></i>Save Itinerary
          </button>
        </div>
      </div>
    </div>
  </div>
}
